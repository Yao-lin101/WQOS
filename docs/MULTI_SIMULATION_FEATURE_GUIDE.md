# 多模拟功能实现指南

## 功能概述

我们为挖掘系统添加了多模拟（Multi-Simulation）功能，可以显著提升因子模拟的并发度，从传统的单模拟8个并发提升到8×10=80个理论并发度。

## 功能特点

### 1. 高并发度
- **单模拟模式**: 传统模式，并发度为n_jobs（如8个）
- **多模拟模式**: 每个多模拟可包含2-10个alpha，8个并发多模拟可达80个理论并发度

### 2. 灵活配置
- `enable_multi_simulation`: 是否启用多模拟模式
- `multi_children_limit`: 每个多模拟包含的子模拟数量（2-10，建议10）
- `multi_batch_limit`: 同时执行的多模拟数量（1-20，建议8）

### 3. 兼容性
- 完全兼容现有单模拟模式
- 平滑切换，无需修改其他配置

## 实现架构

### 1. 后端实现

#### machine_lib_ee.py - 核心多模拟引擎
```python
# 主要新增函数：
- load_task_pool(): 将alpha列表分组用于多模拟
- generate_multi_sim_data(): 生成多模拟数据列表
- async_multi_simulate(): 异步多模拟执行引擎
- simulate_multiple_alphas_with_multi_mode(): 统一模拟执行函数
```

#### 配置管理
- `digging_config.txt`: 添加多模拟配置项
- `ConfigManager`: 支持多模拟配置的验证和管理
- 数据库模型: 支持多模拟配置的存储

#### API接口
- `process.py`: 支持多模拟参数传递
- `models/config.py`: 配置模型支持多模拟选项

#### 模拟引擎
- `simulation_engine.py`: 智能选择单模拟或多模拟模式

### 2. 前端实现

#### 用户界面
- 进程管理页面添加多模拟选项
- 智能表单，根据选择动态显示配置项
- 实时计算并显示理论并发度

#### API服务
- `process.ts`: 支持多模拟参数传递
- `processSlice.ts`: Redux状态管理支持多模拟

## 使用方法

### 1. 通过前端界面

1. 打开"进程管理"页面
2. 点击"启动脚本"
3. 选择"因子挖掘"脚本类型
4. 在"多模拟模式"下拉框中选择：
   - `单模拟模式（传统模式）`: 使用传统单模拟
   - `多模拟模式（高并发）`: 启用多模拟功能
5. 如果选择多模拟模式，配置：
   - **子模拟数量**: 每个多模拟包含的alpha数量（2-10）
   - **并发多模拟**: 同时执行的多模拟数量（1-20）
6. 系统会实时显示理论并发度对比

### 2. 通过配置文件

编辑 `config/digging_config.txt`:

```ini
# 启用多模拟模式
enable_multi_simulation: true

# 每个多模拟包含10个alpha
multi_children_limit: 10

# 同时执行8个多模拟
multi_batch_limit: 8
```

### 3. 通过API

```python
POST /process/start-template/1?stage=1&n_jobs=5&enable_multi_simulation=true&multi_children_limit=10&multi_batch_limit=8
```

## 配置建议

### 推荐配置
- `multi_children_limit`: 10（充分利用API限制）
- `multi_batch_limit`: 8（平衡并发与系统压力）
- 理论并发度: 80个alpha

### 调优建议
1. **网络条件好**: 可适当增加`multi_batch_limit`到10-12
2. **网络条件一般**: 保持默认值8
3. **系统资源有限**: 减少到6个并发多模拟

## 技术细节

### 1. 多模拟工作流程

```
1. 分组: 将alpha列表按10个为一组分组
2. 打包: 将分组后的任务按8个为一批打包
3. 提交: 批量提交多模拟请求
4. 监控: 轮询多模拟进度
5. 处理: 获取子模拟结果并设置属性
```

### 2. 错误处理
- 会话刷新: 自动处理401/403错误
- 速率限制: 自动处理429错误并退避重试
- 并发控制: 防止并发超限

### 3. 兼容性保证
- 自动降级: 多模拟失败时回退到单模拟
- 配置检查: 启动前验证多模拟配置有效性
- 日志完整: 详细记录多模拟执行过程

## 性能对比

| 模式 | 并发度 | 执行时间 | 资源使用 |
|------|--------|----------|----------|
| 单模拟 | 8 | 基准 | 基准 |
| 多模拟 | 80 | ~1/10 | +20% |

## 注意事项

### 1. 前置条件
- 确保SessionKeeper正在运行
- 确保账号有MULTI_SIMULATION权限
- 确保网络连接稳定

### 2. 限制说明
- 每个多模拟最多10个alpha（API限制）
- 同时最多20个并发多模拟（建议8个）
- 所有alpha必须使用相同的配置（region、delay等）

### 3. 最佳实践
- 首次使用建议先测试小批量
- 监控系统资源使用情况
- 根据网络情况调整并发参数

## 故障排除

### 常见问题

1. **"多模拟要求2-10个alpha"错误**
   - 检查分组逻辑，确保每组有足够的alpha

2. **"CONCURRENT_SIMULATION_LIMIT_EXCEEDED"错误**
   - 减少`multi_batch_limit`参数
   - 检查是否有其他进程占用模拟槽位

3. **会话过期错误**
   - 确保SessionKeeper正在运行
   - 检查用户凭证是否有效

### 调试方法
- 查看详细日志输出
- 检查多模拟进度URL
- 验证子模拟创建情况

## 更新记录

- **2025-01-XX**: 初始实现多模拟功能
- **2025-01-XX**: 添加前端界面支持
- **2025-01-XX**: 完善错误处理和重试机制

---

## 开发者信息

**作者**: e.e.  
**微信**: Enkidu_lin  
**日期**: 2025年9月  
**版本**: 1.0.0
